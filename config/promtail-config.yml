server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

    external_labels:
      environment: ${ENVIRONMENT:-production}
      cluster: portfolio

scrape_configs:
  - job_name: backend
    static_configs:
      - targets:
          - localhost
        labels:
          job: portfolio-backend
          service: backend
          __path__: /var/log/portfolio/*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            target: target
            request_id: fields.request_id
            method: fields.method
            uri: fields.uri
            status: fields.status
            duration_ms: fields.duration_ms

      - labels:
          level:
          target:
          request_id:
          method:
          status:

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - match:
          selector: '{level=""}'
          action: drop

  - job_name: frontend-server
    static_configs:
      - targets:
          - localhost
        labels:
          job: portfolio-frontend
          service: frontend
          log_type: server
          __path__: /var/log/frontend/server/*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            context: context
            metadata: metadata

      - json:
          source: context
          expressions:
            request_id: requestId
            component: component
            url: url

      - labels:
          level:
          component:
          request_id:

      - timestamp:
          source: timestamp
          format: RFC3339

  - job_name: frontend-client
    static_configs:
      - targets:
          - localhost
        labels:
          job: portfolio-frontend
          service: frontend
          log_type: client
          __path__: /var/log/frontend/server/combined.log

    pipeline_stages:
      # Step 1: extract top-level fields + the context blob
      - json:
          expressions:
            context: context
            timestamp: timestamp
            level: level
            message: message

      # Step 2: pull source out of context so we can filter on it
      - json:
          source: context
          expressions:
            source: source

      # Step 3: promote source to a real label
      - labels:
          source:

      # Step 4: drop anything that is NOT a client log (action:drop needs no stages)
      - match:
          selector: '{source!="client"}'
          action: drop

      # Step 5: extract remaining client-specific fields from context
      - json:
          source: context
          expressions:
            component: component
            device_type: deviceType
            user_agent: userAgent

      - labels:
          level:
          component:
          device_type:

      - timestamp:
          source: timestamp
          format: RFC3339

  - job_name: errors
    static_configs:
      - targets:
          - localhost
        labels:
          job: portfolio-errors
          priority: high
          __path__: /var/log/portfolio/error.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            target: target
            error: fields.error

      - labels:
          level:
          target:

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - match:
          selector: '{level!~"error|fatal"}'
          action: drop

limits_config:
  readline_rate: 10000
  readline_burst: 20000
  max_streams: 1000
